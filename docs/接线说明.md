# ESP32智能环境监控与语音助手 - 接线说明

## 总体接线图

```
                  +-----------------+
                  |                 |
                  |    ESP32-S      |
                  |    NodeMCU      |
                  |                 |
                  +-----------------+
                      |  |  |  |  |  |
         +------------+  |  |  |  +--+----------+
         |               |  |  |     |          |
         v               v  v  v     v          v
  +-----------+    +-----------+    +------------------+    +----------+
  |  INMP441  |    | 0.91" OLED|    |   MAX98357A      |    |  按钮    |
  | 麦克风模块 |    | 显示模块  |    |  扬声器驱动模块  |    | (录音控制)|
  +-----------+    +-----------+    +------------------+    +----------+
                                            |
                                            v
                                     +-------------+
                                     |   扬声器    |
                                     +-------------+
```

## 详细接线说明

### 1. INMP441麦克风模块接线

INMP441是一个I2S数字麦克风模块，需要连接到ESP32的I2S接口。

| INMP441引脚 | ESP32引脚 | 说明 |
|------------|-----------|------|
| VDD        | 3.3V      | 电源正极 |
| GND        | GND       | 电源地 |
| SD         | GPIO33    | I2S数据线 |
| L/R        | GND       | 左/右声道选择，接地为左声道 |
| WS         | GPIO25    | Word Select/LRCLK (左右声道时钟) |
| SCK        | GPIO32    | Serial Clock/BCLK (位时钟) |

### 2. MAX98357A扬声器模块接线

MAX98357A是I2S接口的音频放大器模块，连接扬声器输出音频。

| MAX98357A引脚 | ESP32引脚 | 说明 |
|--------------|-----------|------|
| VIN          | 5V        | 电源正极，建议使用5V |
| GND          | GND       | 电源地 |
| DIN          | GPIO14    | I2S数据输入 |
| BCLK         | GPIO26    | 位时钟 |
| LRC          | GPIO27    | 左右声道时钟 |
| SD           | 3.3V/NC   | 静音控制，高电平或悬空为启用 |
| GAIN         | 按需设置   | 增益设置，请参考模块说明 |

### 3. 0.91寸OLED显示屏接线

这是一个I2C接口的OLED显示屏，地址为0x3C。

| OLED引脚 | ESP32引脚 | 说明 |
|---------|-----------|------|
| VCC     | 3.3V      | 电源正极 |
| GND     | GND       | 电源地 |
| SCL     | GPIO22    | I2C时钟线 |
| SDA     | GPIO21    | I2C数据线 |

### 4. 录音控制按钮接线

使用轻触按钮控制录音开始和停止，按下开始录音，松开停止录音。

| 按钮接线 | ESP32引脚 | 说明 |
|----------|-----------|------|
| 一端     | GPIO15    | 按钮信号输入引脚 |
| 另一端   | GND       | 接地 |

**注意**：需要在GPIO15和3.3V之间连接一个10kΩ的上拉电阻，保证按钮未按下时引脚为高电平。

接线示意图：
```
    3.3V
     |
     v
    10kΩ
     |
     +-----> GPIO15 (信号输入)
     |
    按钮
     |
    GND
```

### 5. 电源连接

ESP32开发板可以通过USB供电或使用锂电池：

- **USB供电**：直接使用Micro USB/Type-C线连接电脑或适配器
- **锂电池供电**：
  - 如果开发板带有电池接口，直接连接锂电池
  - 如使用外部电池，需要通过电池保护板连接到ESP32的5V和GND引脚

## 音频曲线显示配置

为了在OLED屏幕上显示实时音频曲线，需确保以下配置：

1. **OLED接线确认**：
   - 确保OLED显示屏正确连接到ESP32的I2C接口(GPIO21/GPIO22)
   - 验证I2C地址设置正确(通常是0x3C)

2. **音频采样设置**：
   - 采样率建议设置为16KHz，满足语音识别需求并适合OLED显示
   - 使用I2S DMA缓冲区进行高效采样
   - 建议缓冲区大小：512或1024字节

3. **显示处理流程**：
   ```
   麦克风采样 → 数据缓冲 → FFT/幅值分析 → 波形缩放 → OLED显示
   ```

4. **采样数据处理**：
   - 建议实现简单的AGC(自动增益控制)调整显示幅度
   - 对原始数据应用窗函数(如汉宁窗)减少频谱泄漏
   - 使用移动平均滤波减少噪声干扰

## 语音采集优化建议

为提高语音采集质量和识别率，建议采取以下措施：

1. **硬件优化**：
   - 麦克风周围添加简单的声学屏障，减少环境噪声
   - INMP441模块与ESP32之间的连接线尽量短且使用屏蔽线
   - 在麦克风和ESP32电源部分增加去耦电容(100nF)

2. **软件优化**：
   - 实现静态噪声消除算法
   - 采用高通滤波器(80Hz截止频率)消除低频噪声
   - 实现VAD(语音活动检测)算法，仅在检测到语音时进行处理
   - 采集前进行简单的声学校准

3. **采样参数建议**：
   | 参数 | 推荐值 | 说明 |
   |------|--------|------|
   | 采样率 | 16KHz | 满足语音识别需求 |
   | 采样位深 | 16位 | 提供足够的动态范围 |
   | I2S模式 | PHILIPS标准 | 与INMP441兼容 |
   | DMA缓冲 | 8-16块 | 每块512字节 |

4. **OLED显示音频曲线的软件实现**：
   - 使用循环缓冲区存储最近的音频数据
   - 对数据进行归一化处理以适应OLED高度
   - 可选择时域波形或频谱图显示模式
   - 刷新率建议控制在15-30fps，避免影响主要处理任务

## 音频曲线显示效果调优

为了在0.91寸OLED上获得良好的音频曲线显示效果：

1. **显示模式选择**：
   - 波形模式：直观显示声音波形
   - 频谱模式：显示不同频段的能量分布
   - 电平指示：简单显示当前音量水平

2. **刷新逻辑**：
   - 推荐使用双缓冲技术减少闪烁
   - 屏幕更新与音频采样过程解耦，使用单独任务更新显示

3. **视觉优化**：
   - 使用抗锯齿算法平滑波形线条
   - 实现简单的峰值保持功能
   - 可添加网格或参考线帮助观察波形变化

## 按钮控制录音功能说明

为实现按钮控制录音功能，系统采用以下工作流程：

1. **默认状态**：
   - 设备处于待机状态，麦克风不进行录音
   - OLED显示待机界面或基本信息

2. **按钮操作**：
   - 按下按钮时：GPIO15变为低电平，触发录音开始
   - 松开按钮时：GPIO15恢复高电平，触发录音停止
   - 按钮按下时，OLED屏幕会显示"Listening..."，提示用户系统正在聆听

3. **软件实现要点**：
   - 使用中断方式检测按钮状态变化
   - 采用防抖处理，避免按钮抖动引起误触发
   - 录音状态可在OLED上通过图标或文字提示
   - 当按钮被按下时，OLED显示"Listening..."文本，松开后恢复正常显示

4. **应用场景**：
   - 长按模式：适合需要持续录音的场景，如语音命令输入
   - 可通过软件配置实现"按一下开始录音，再按一下停止录音"的切换模式

## 注意事项

1. **电源管理**：
   - 确保所有模块共用同一个GND参考点
   - 麦克风和OLED使用3.3V供电，扬声器模块推荐使用5V供电
   - 如果同时使用多个模块，确保电源能提供足够电流

2. **I2S时钟设置**：
   - 麦克风和扬声器使用不同的I2S控制器，避免引脚冲突
   - 软件中需要正确配置每个I2S设备的时钟频率和格式

3. **噪声处理**：
   - 扬声器和麦克风的连接线尽量分开布置，避免干扰
   - 可以在电源线上添加去耦电容，减少噪声

4. **调试技巧**：
   - 首先逐个测试各个模块的基本功能
   - 出现问题时先检查接线，再检查软件配置
   - 可使用万用表检查供电电压是否正常

1. **按钮使用注意**：
   - 确保按钮安装牢固，避免松动导致接触不良
   - 如果使用金属外壳，注意按钮与外壳之间的绝缘处理
   - 长时间使用后检查按钮是否灵敏，必要时进行更换

## 组装步骤

1. 在连接任何组件前，确保ESP32未供电
2. 按照上述表格连接INMP441麦克风模块
3. 连接MAX98357A扬声器模块，并将扬声器接到模块输出端
4. 连接OLED显示屏
5. 最后连接电源，优先使用USB供电进行测试
6. 上电后，使用基本测试程序验证各个组件功能

## 扩展模块接线（可选）

如需添加温湿度传感器等扩展模块，可参考以下接线建议：

### DHT22/AM2302温湿度传感器

| DHT22引脚 | ESP32引脚 | 说明 |
|----------|-----------|------|
| VCC      | 3.3V      | 电源正极 |
| DATA     | GPIO17    | 数据线，需上拉电阻(4.7kΩ至10kΩ) |
| GND      | GND       | 电源地 |
